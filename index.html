<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>COPAIBA ‚öôÔ∏è Editor de oto.ini</title>

  <!-- Tailwind utilit√°rio -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Encoding.js (opcional) para salvar Shift_JIS de fato -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/encoding-japanese/1.0.30/encoding.min.js" defer></script>
  <!-- FFT.js para espectrograma -->
  <script src="https://cdn.jsdelivr.net/npm/fft.js@0.3.0/dist/fft.min.js" defer></script>

  <style>
    .card{border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .card-header{display:flex;align-items:center;justify-content:space-between;padding:.5rem .75rem;border-bottom:1px solid #e5e7eb;border-top-left-radius:16px;border-top-right-radius:16px}
    .float-btn{font-size:12px;line-height:1;border:1px solid #e5e7eb;background:transparent;border-radius:10px;padding:.25rem .4rem;cursor:pointer}
    .float-btn:hover{background:rgba(0,0,0,.04)}
    .floatable.floating{position:fixed;inset:auto auto auto auto;width:560px;max-width:90vw;z-index:9999;box-shadow:0 12px 24px rgba(0,0,0,.18)}
    .floating .card-body{max-height:70vh;overflow:auto}
    .floating .drag-handle{cursor:move}
    .dragging{user-select:none}
    canvas{display:block;width:100%}
    #wave{height:260px}
    #mini{height:60px}
    #spec{height:180px}
    .tag{font-size:10px;padding:.1rem .4rem;border-radius:.5rem;border:1px solid #e5e7eb;background:#f8fafc}
    .marker-label{position:absolute;transform:translate(-50%,-100%);background:#111827;color:#fff;font-size:10px;padding:2px 6px;border-radius:6px;white-space:nowrap;pointer-events:auto;cursor:pointer}
    .handle{position:absolute;width:8px;height:100%;transform:translateX(-50%);cursor:ew-resize;background:transparent}
    .marker-selected{outline:2px solid #111827}
    textarea{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .drop-hint{border:2px dashed #cbd5e1;border-radius:12px;padding:.5rem .75rem}
    .drop-active{background:#f0f9ff;border-color:#38bdf8;color:#0ea5e9}
    .floating{resize:both;overflow:hidden}
    #labels{position:absolute;inset:0;pointer-events:none}
    #labels .handle,#labels .marker-label{pointer-events:auto}

    /* ===== Temas ===== */
    :root{
      --bg:#ffffff; --text:#111827; --muted:#6b7280; --card:#ffffff;
      --accent:#2563eb; --grid:#e5e7eb; --label-bg:#f9fafb; --border:#e5e7eb; --input-bg:#ffffff;
    }
    body.theme-dark{
      --bg:#020617; --text:#e5e7eb; --muted:#9ca3af; --card:#020617;
      --accent:#38bdf8; --grid:#1f2937; --label-bg:#020617; --border:#1f2937; --input-bg:#020617;
    }
    body{background:var(--bg);color:var(--text)}
    header{background:var(--bg);border-bottom:1px solid var(--border)}
    .card{background:var(--card);border-color:var(--border);box-shadow:0 1px 2px rgba(15,23,42,.25)}
    .card-header{background:rgba(15,23,42,0.02);border-bottom-color:var(--border)}
    .text-muted{color:var(--muted)} .accent{color:var(--accent)} .border-accent{border-color:var(--accent)}
    #labels .marker-label{background:var(--label-bg);color:var(--text);border:1px solid var(--accent)}
    .handle{background:linear-gradient(to bottom,transparent,var(--accent) 40%,var(--accent) 60%,transparent);opacity:.25}
    input,select,textarea{background-color:var(--input-bg);color:var(--text)} input::placeholder,textarea::placeholder{color:var(--muted)} button{color:var(--text)}
    .tag{border-color:var(--border);background:rgba(148,163,184,0.1);color:var(--muted)}

    /* Dock de janelas minimizadas */
    #dock{position:fixed;left:12px;bottom:12px;display:flex;gap:8px;flex-wrap:wrap;z-index:10000}
    #dock .dock-item{background:var(--card);border:1px solid var(--border);padding:.35rem .55rem;border-radius:.75rem;box-shadow:0 2px 8px rgba(0,0,0,.2);cursor:pointer;font-size:12px}
    #dock .dock-item:hover{outline:1px solid var(--accent)}
    .minimized{display:none !important}
  </style>
</head>

<body class="theme-light">
  <header class="sticky top-0 z-10 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <h1 class="text-2xl font-semibold">COPAIBA ‚öôÔ∏è Editor de oto.ini</h1>

      <div class="flex items-center gap-2 ml-auto">
        <input id="pickFolder" type="file" webkitdirectory directory multiple accept="audio/wav" class="hidden" />
        <input id="pickOto" type="file" accept=".ini,.txt" class="hidden" />
        <select id="otoEncoding" class="px-2 py-1 rounded-lg border bg-transparent text-xs">
          <option value="auto" selected>Detec√ß√£o autom√°tica</option>
          <option value="utf-8">UTF-8 (OpenUTAU)</option>
          <option value="shift_jis">ANSI JP (Shift_JIS / UTAU legado)</option>
          <option value="windows-1252">ANSI Latin-1 (pt-BR)</option>
          <option value="utf-16le">Unicode (UTF-16 LE)</option>
        </select>
        <span id="encodingBadge" class="tag text-[10px]" title="Codifica√ß√£o usada ao ler o oto.ini">UTF-8 (auto)</span>

        <button id="btnFolder" class="px-3 py-1.5 rounded-xl border bg-transparent hover:bg-black/5">Abrir pasta .wav</button>
        <button id="btnOto" class="px-3 py-1.5 rounded-xl border bg-transparent hover:bg-black/5">Carregar oto.ini</button>
        <button id="btnSave" class="px-3 py-1.5 rounded-xl border bg-transparent hover:bg-black/5 disabled:opacity-50" disabled>Exportar oto.ini</button>

        <!-- Tema -->
        <button id="btnTheme" class="px-3 py-1.5 rounded-xl border bg-transparent hover:bg-black/5 text-sm" title="Alternar modo claro/escuro">üåô</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <div class="grid grid-cols-12 gap-4">
      <!-- ESQUERDA: Arquivos / Filtros -->
      <aside class="col-span-12 md:col-span-4">
        <div id="pane-files" class="card floatable" data-float-key="files">
          <div class="card-header drag-handle">
            <div class="flex items-center gap-2">
              <span class="text-sm">Arquivos e aliases</span>
              <span id="countAliases" class="tag">0</span>
              <span id="countStars" class="tag" title="Itens marcados (‚òÖ)">‚òÖ 0</span>
            </div>
            <div class="flex items-center gap-2">
              <button class="float-btn" data-minimize title="Minimizar">_</button>
              <button class="float-btn" data-float-toggle title="Destacar/Voltar">üóñ</button>
            </div>
          </div>

          <div class="card-body p-3 space-y-2">
            <!-- FILTRO PERSONALIZ√ÅVEL -->
            <div class="space-y-2">
              <div class="flex items-center gap-2">
                <input id="filter" placeholder='Filtrar‚Ä¶ (ex.: b ou "b r")' class="w-full px-2 py-1 rounded-lg border bg-transparent text-sm" />
              </div>
              <div class="flex items-center gap-3 text-xs text-muted">
                <label class="flex items-center gap-1">
                  <input id="filterRegex" type="checkbox" class="accent-blue-500"> Regex
                </label>
                <label class="flex items-center gap-1">
                  <input id="filterStarred" type="checkbox" class="accent-blue-500"> Somente ‚òÖ
                </label>
                <button id="btnSelectResults" class="px-2 py-1 rounded-lg border bg-transparent">Selecionar resultados</button>
                <button id="btnClearSelection" class="px-2 py-1 rounded-lg border bg-transparent">Limpar sele√ß√£o</button>
                <button id="btnStarResults" class="px-2 py-1 rounded-lg border bg-transparent" title="Marca/Desmarca ‚òÖ dos resultados atuais">‚òÖ/‚òÜ resultados</button>
              </div>
              <p class="text-xs text-muted">Dicas: termos separados por espa√ßo fazem <strong>OR</strong>. Ative <em>Regex</em> para usar padr√µes avan√ßados.</p>
            </div>

            <div id="aliasList" class="max-h-[60vh] overflow-auto divide-y divide-slate-200/40"></div>
          </div>
        </div>
      </aside>

      <!-- DIREITA -->
      <section class="col-span-12 md:col-span-8 space-y-3">
        <!-- Waveform & Controles -->
        <div id="pane-wave" class="card floatable" data-float-key="wave">
          <div class="card-header drag-handle">
            <div class="text-sm">
              <span id="currentName" class="font-medium">(nenhum arquivo)</span>
              <span id="srInfo" class="ml-2 text-muted text-xs"></span>
            </div>
            <div class="flex items-center gap-3 text-xs text-muted">
              <div class="hidden sm:flex items-center gap-2">
                <button id="btnPlay" class="px-2 py-1 rounded-lg border bg-transparent">‚ñ∂Ô∏è Tocar/Pausar</button>
                <button id="btnStop" class="px-2 py-1 rounded-xl border bg-transparent">‚èπÔ∏è</button>
              </div>
              <div class="flex items-center gap-2">
                <input id="zoom" type="range" min="1" max="128" step="1" value="1" />
                <span id="zoomLabel">1√ó</span>
                <span>H-Zoom</span>
              </div>
              <div class="flex items-center gap-2">
                <input id="vzoom" type="range" min="0.25" max="4" step="0.05" value="1" />
                <span id="vzoomLabel">1.00√ó</span>
                <span>V-Zoom</span>
              </div>
              <label class="flex items-center gap-1">
                <input id="toggleSpec" type="checkbox" class="accent-blue-500"> Espectrograma
              </label>
              <button class="float-btn" data-minimize title="Minimizar">_</button>
              <button class="float-btn" data-float-toggle title="Destacar/Voltar">üóñ</button>
            </div>
          </div>
          <div class="card-body">
            <div class="relative">
              <canvas id="wave" height="260"></canvas>
              <div id="labels"></div>
            </div>
            <div class="border-t" style="border-color:var(--border);">
              <div class="px-3 py-2">
                <canvas id="mini" height="60"></canvas>
              </div>
            </div>

            <div id="specWrap" class="mt-2 hidden">
              <canvas id="spec" height="180"></canvas>
              <div class="text-xs text-muted px-2 pt-1">Espectrograma: janela 1024 ‚Ä¢ hop 256 ‚Ä¢ Hann ‚Ä¢ dB normalizado</div>
            </div>

            <div class="px-3 pb-2 text-xs text-muted">
              Q/W/E/R/T = marcar ‚Ä¢ Y = tocar/pausar ‚Ä¢ 0 = duplicar ‚Ä¢ 9 = renomear ‚Ä¢ S = alternar ‚òÖ ‚Ä¢ ‚Üë/‚Üì = navegar ‚Ä¢ Roda = H-Zoom ‚Ä¢ Shift+Roda = rolar ‚Ä¢ Alt+Roda = V-Zoom
            </div>
          </div>
        </div>

        <!-- Par√¢metros -->
        <div id="pane-params" class="card floatable" data-float-key="params">
          <div class="card-header drag-handle">
            <span class="text-sm">Configura√ß√µes dos par√¢metros</span>
            <div class="flex items-center gap-2">
              <button class="float-btn" data-minimize title="Minimizar">_</button>
              <button class="float-btn" data-float-toggle title="Destacar/Voltar">üóñ</button>
            </div>
          </div>
          <div class="card-body p-3">
            <div class="grid grid-cols-12 gap-3 items-end">
              <div class="col-span-6 md:col-span-2">
                <label class="text-xs text-muted">Alias/Fonema/Legenda</label>
                <input id="alias" class="w-full px-2 py-2 rounded-lg border bg-transparent" placeholder="alias" />
              </div>
              <div class="col-span-6 md:col-span-2">
                <label class="text-xs text-muted">Corte inicial (Q)</label>
                <input id="offset" type="number" class="w-full px-2 py-2 rounded-lg border bg-transparent" step="1" />
              </div>
              <div class="col-span-6 md:col-span-2">
                <label class="text-xs text-muted">Transi√ß√£o (W)</label>
                <input id="overlap" type="number" class="w-full px-2 py-2 rounded-lg border bg-transparent" step="1" />
              </div>
              <div class="col-span-6 md:col-span-2">
                <label class="text-xs text-muted">In√≠cio da vogal (E)</label>
                <input id="preutter" type="number" class="w-full px-2 py-2 rounded-lg border bg-transparent" step="1" />
              </div>
              <div class="col-span-6 md:col-span-2">
                <label class="text-xs text-muted">Parte de loop (R)</label>
                <input id="consonant" type="number" class="w-full px-2 py-2 rounded-lg border bg-transparent" step="1" />
              </div>
              <div class="col-span-6 md:col-span-2">
                <label class="text-xs text-muted">Corte final (T)</label>
                <input id="cutoff" type="number" class="w-full px-2 py-2 rounded-lg border bg-transparent" step="1" />
              </div>
            </div>
          </div>
        </div>

        <!-- oto.ini -->
        <div id="pane-oto" class="card floatable" data-float-key="oto">
          <div class="card-header drag-handle">
            <div class="flex items-center gap-2">
              <span class="text-sm">oto.ini (edit√°vel)</span>
              <span id="countLines" class="tag">0</span>
            </div>
            <div class="flex items-center gap-2">
              <button class="float-btn" data-minimize title="Minimizar">_</button>
              <button class="float-btn" data-float-toggle title="Destacar/Voltar">üóñ</button>
            </div>
          </div>
          <div class="card-body p-3">
            <textarea id="otoView" class="w-full h-60 p-2 rounded-lg border bg-transparent text-xs leading-5" spellcheck="false"></textarea>
          </div>
        </div>

        <!-- Log -->
        <div id="pane-log" class="card floatable" data-float-key="log" style="max-height:280px">
          <div class="card-header drag-handle">
            <div class="flex items-center gap-2">
              <span class="text-sm">Log de a√ß√µes</span>
            </div>
            <div class="flex items-center gap-2">
              <button id="btnUndo" class="px-2 py-1 rounded-lg border bg-transparent">‚Ü∂ Desfazer</button>
              <button id="btnRedo" class="px-2 py-1 rounded-lg border bg-transparent">‚Ü∑ Refazer</button>
              <button class="float-btn" data-minimize title="Minimizar">_</button>
              <button class="float-btn" data-float-toggle title="Destacar/Voltar">üóñ</button>
            </div>
          </div>
          <div class="card-body p-2">
            <div id="logList" class="space-y-1 max-h-48 overflow-auto text-xs"></div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Dock de janelas minimizadas -->
  <div id="dock" class="hidden"></div>

  <script>
  /* ===== Helpers ===== */
  const $ = id => document.getElementById(id);
  const qs = (sel,root=document)=> root.querySelector(sel);
  const qsa = (sel,root=document)=> [...root.querySelectorAll(sel)];
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  const basename = (p)=> (p||'').split(/[\\/]/).pop();
  const lower = (s)=> String(s||'').toLowerCase();
  const round0=(x)=> Math.round(Number(x||0));
  const fmt = (ms)=> String(round0(ms));

  /* ===== Log & Undo/Redo ===== */
  const logList = $('logList'); let undoStack=[], redoStack=[];
  function logMsg(msg){ const line=document.createElement('div'); line.className='text-xs font-mono leading-5';
    line.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`; logList.appendChild(line); logList.scrollTop=logList.scrollHeight; }
  function updateUndoRedoButtons(){ $('btnUndo').disabled = !undoStack.length; $('btnRedo').disabled = !redoStack.length; }
  function pushAction(action, desc){ undoStack.push(action); redoStack=[]; logMsg(desc); updateUndoRedoButtons(); }
  function pushPatch(index,before,after,desc){ if(JSON.stringify(before)===JSON.stringify(after)) return; pushAction({type:'patch',index,before,after},desc); }
  function applyAction(action,dir){
    if(action.type==='patch'){ const i=action.index; if(!rows[i]) return; rows[i]={...(dir==='undo'?action.before:action.after)}; if(selectedRowIndex===i) loadParamsToUI();
      refreshOtoView(); renderAliasList(); drawAll(); }
    else if(action.type==='insert'){ if(dir==='undo') rows.splice(action.index,1); else rows.splice(action.index,0,{...action.row});
      selectedRowIndex=Math.min(action.index, rows.length-1); renderAliasList(); refreshOtoView(); if(rows.length) selectRow(selectedRowIndex); }
    else if(action.type==='remove'){ if(dir==='undo'){ rows.splice(action.index,0,{...action.row}); selectedRowIndex=action.index; renderAliasList(); refreshOtoView(); selectRow(selectedRowIndex); }
      else { rows.splice(action.index,1); selectedRowIndex=Math.min(action.index, rows.length-1); renderAliasList(); refreshOtoView(); if(rows.length) selectRow(selectedRowIndex); } }
  }
  $('btnUndo').addEventListener('click',()=>{const a=undoStack.pop(); if(!a) return; redoStack.push(a); applyAction(a,'undo'); logMsg('Undo'); updateUndoRedoButtons();});
  $('btnRedo').addEventListener('click',()=>{const a=redoStack.pop(); if(!a) return; undoStack.push(a); applyAction(a,'redo'); logMsg('Redo'); updateUndoRedoButtons();});

  /* ===== Float, Dock e Minimizar ===== */
  const FLOAT_KEY_PREFIX='flt:'; const DOCK_KEY='dock:';
  const dock = $('dock');
  function ensureDockVisible(){ dock.classList.toggle('hidden', dock.children.length===0); }
  function makeFloating(pane, saved=null){
    pane.classList.add('floating'); const rect=pane.getBoundingClientRect();
    pane.style.left=(saved?.left ?? 60)+'px'; pane.style.top=(saved?.top ?? 80)+'px'; pane.style.width=(saved?.width ?? Math.max(460,rect.width))+'px';
    pane.style.height=(saved?.height ?? rect.height)+'px'; qs('[data-float-toggle]',pane).textContent='üóó'; bringToFront(pane); savePaneState(pane,{floating:true});
  }
  function dockPane(pane){ pane.classList.remove('floating'); pane.style.left='';pane.style.top='';pane.style.width='';pane.style.height=''; qs('[data-float-toggle]',pane).textContent='üóñ'; savePaneState(pane,{floating:false}); }
  function bringToFront(pane){ const zs=qsa('.floating').map(p=>parseInt(getComputedStyle(p).zIndex||'9999',10)); pane.style.zIndex=((zs.length?Math.max(...zs):9999)+1).toString(); }
  function positionPane(pane,left,top){ const vw=innerWidth,vh=innerHeight, r=pane.getBoundingClientRect(), w=r.width,h=r.height; pane.style.left=clamp(left,0,Math.max(0,vw-w))+'px'; pane.style.top=clamp(top,0,Math.max(0,vh-h))+'px'; }
  function savePaneState(pane,patch={}){ const key=pane.dataset.floatKey||''; if(!key) return; const r=pane.getBoundingClientRect();
    const prev=JSON.parse(localStorage.getItem(FLOAT_KEY_PREFIX+key)||'{}'); const data={floating:pane.classList.contains('floating'),left:r.left,top:r.top,width:r.width,height:r.height,...patch};
    localStorage.setItem(FLOAT_KEY_PREFIX+key, JSON.stringify({...prev,...data})); }

  function initFloatables(){
    qsa('.floatable').forEach(pane=>{
      const btnFloat = qs('[data-float-toggle]',pane);
      const btnMin = qs('[data-minimize]',pane);
      const header = qs('.card-header',pane);
      const key = pane.dataset.floatKey || '';
      const saved = key ? JSON.parse(localStorage.getItem(FLOAT_KEY_PREFIX+key)||'null') : null;
      if(saved?.floating) makeFloating(pane, saved);
      if(saved?.minimized) minimizePane(pane,true);

      btnFloat?.addEventListener('click',()=>{ pane.classList.contains('floating')?dockPane(pane):makeFloating(pane); });
      btnMin?.addEventListener('click',()=> minimizePane(pane));

      let dragging=false,sx=0,sy=0,sl=0,st=0;
      header.addEventListener('mousedown',(e)=>{ if(!pane.classList.contains('floating')) return; dragging=true; document.body.classList.add('dragging'); sx=e.clientX; sy=e.clientY; const r=pane.getBoundingClientRect(); sl=r.left; st=r.top; e.preventDefault();});
      addEventListener('mousemove',(e)=>{if(!dragging)return; positionPane(pane, sl+(e.clientX-sx), st+(e.clientY-sy));});
      addEventListener('mouseup',()=>{if(!dragging)return; dragging=false; document.body.classList.remove('dragging'); savePaneState(pane);});
      pane.addEventListener('mousedown',()=>{ if(pane.classList.contains('floating')) bringToFront(pane); });
    });
  }

  function minimizePane(pane, boot=false){
    const key=pane.dataset.floatKey||'';
    pane.classList.add('minimized');
    const title = (qs('.card-header span, .card-header .text-sm',pane)?.innerText||'painel').split('\n')[0];
    let item = qs(`.dock-item[data-key="${key}"]`, dock);
    if(!item){
      item = document.createElement('button');
      item.className='dock-item'; item.dataset.key=key; item.textContent=title||key||'painel';
      item.title='Restaurar ‚Äú'+item.textContent+'‚Äù';
      item.addEventListener('click',()=> restorePane(key));
      dock.appendChild(item);
    }
    ensureDockVisible();
    if(!boot) savePaneState(pane,{minimized:true});
  }
  function restorePane(key){
    const pane = qsa('.floatable').find(p=> (p.dataset.floatKey||'')===key); if(!pane) return;
    pane.classList.remove('minimized'); savePaneState(pane,{minimized:false});
    const item = qs(`.dock-item[data-key="${key}"]`, dock); item?.remove(); ensureDockVisible();
  }

  /* ===== Tema & Prefer√™ncias ===== */
  const PREF_KEY='copaiba_prefs_v3';
  const defaultPrefs={theme:'light', vzoom:1, showSpec:false};
  let prefs={...defaultPrefs};
  function loadPrefs(){ try{prefs={...defaultPrefs,...JSON.parse(localStorage.getItem(PREF_KEY)||'{}')}}catch{prefs={...defaultPrefs}}}
  function savePrefs(){ localStorage.setItem(PREF_KEY, JSON.stringify(prefs)); }
  function applyTheme(){
    document.body.classList.remove('theme-light','theme-dark');
    document.body.classList.add('theme-'+(prefs.theme||'light'));
    $('btnTheme').textContent = prefs.theme==='dark'?'‚òÄÔ∏è':'üåô';
    $('btnTheme').title = prefs.theme==='dark'?'Alternar para modo claro':'Alternar para modo escuro';
  }

  /* ===== OTO parsing/serialize ===== */
  function parseOto(text){
    const lines=String(text).replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n'); const out=[];
    for(const raw of lines){ if(!raw.trim()) continue; const i=raw.indexOf('='); if(i<0) continue;
      const filename=raw.slice(0,i).trim(); const parts=raw.slice(i+1).split(',');
      const toNum=j=> round0(parts[j]||0);
      out.push({ filename, alias:(parts[0]||'').trim(), offset:toNum(1), consonant:toNum(2), cutoff:-Math.abs(toNum(3)), preutter:toNum(4), overlap:toNum(5) });
    }
    return out;
  }
  function serializeOto(rows){
    return rows.map(p=> `${p.filename}=${[p.alias||'',round0(p.offset),round0(p.consonant),round0(p.cutoff),round0(p.preutter),round0(p.overlap)].join(',')}`).join('\n');
  }
  function inferAlias(filename){ return basename(filename).replace(/\.[^.]+$/,''); }

  /* ===== Estado principal ===== */
  let audioCtx; let currentBuffer=null; let source=null;
  let files=[]; let rows=[]; let selectedRowIndex=-1; let selectedRowIndices=[];
  let zoom=1, vzoom=prefs.vzoom||1; let viewStartMs=0; let cursorMs=0; let selectedMarkerId=null; let lastMouseX=null;

  // Progresso / estrelas
  const STAR_KEY='copaiba_stars_v1';
  let starSet = new Set(); // keys: filename|alias
  function loadStars(){ try{starSet=new Set(JSON.parse(localStorage.getItem(STAR_KEY)||'[]')); }catch{ starSet=new Set(); } }
  function saveStars(){ localStorage.setItem(STAR_KEY, JSON.stringify([...starSet])); }
  function keyFor(r){ return (r?.filename||'')+'|'+(r?.alias||''); }
  function updateStarCounter(){ $('countStars').textContent = '‚òÖ '+String(starSet.size); }

  // Espectrograma cache por arquivo
  const specCache = new Map(); // key: fileIndex => {cols,rows,data,minDB,maxDB}

  const COLORS = { overlap:'#22c55e', preutter:'#ef4444', consonant:'#ec4899', offset:'#1e3a8a', cutoff:'#60a5fa' };
  const markers = [
    {key:'Q', id:'offset',    color:COLORS.offset,    label:'Corte inicial'},
    {key:'W', id:'overlap',   color:COLORS.overlap,   label:'Transi√ß√£o'},
    {key:'E', id:'preutter',  color:COLORS.preutter,  label:'In√≠cio da vogal'},
    {key:'R', id:'consonant', color:COLORS.consonant, label:'Parte de loop'},
    {key:'T', id:'cutoff',    color:COLORS.cutoff,    label:'Corte final'},
  ];

  /* ===== DOM ===== */
  const wave=$('wave'), ctxWave=wave.getContext('2d');
  const mini=$('mini'), mctx=mini.getContext('2d');
  const spec=$('spec'), sctx=spec.getContext('2d');
  const labelsWrap=$('labels');
  const aliasList=$('aliasList');
  const countAliases=$('countAliases'), countLines=$('countLines');
  const currentName=$('currentName'), srInfo=$('srInfo');
  const aliasIn=$('alias'), offsetIn=$('offset'), consonantIn=$('consonant'), cutoffIn=$('cutoff'), preutterIn=$('preutter'), overlapIn=$('overlap');
  const pickFolder=$('pickFolder'), pickOto=$('pickOto'); const otoView=$('otoView');
  const zoomSlider=$('zoom'), zoomLabel=$('zoomLabel'); const vzoomSlider=$('vzoom'), vzoomLabel=$('vzoomLabel');
  const btnFolder=$('btnFolder'); const encodingSelect=$('otoEncoding'); const encodingBadge=$('encodingBadge');

  const filterInput=$('filter'), filterRegex=$('filterRegex'), filterStarred=$('filterStarred');
  const btnSelectResults=$('btnSelectResults'), btnClearSelection=$('btnClearSelection'), btnStarResults=$('btnStarResults');

  const SPEC_WRAP=$('specWrap'), toggleSpec=$('toggleSpec');

  /* ===== Encodings ===== */
  function countJapaneseChars(str){ let n=0; for(let i=0;i<str.length;i++){ const code=str.charCodeAt(i);
    if((code>=0x3040&&code<=0x30FF)||(code>=0x4E00&&code<=0x9FFF)||(code>=0xFF66&&code<=0xFF9D)) n++; } return n; }
  function decodeBuffer(buf,enc){ try{ return new TextDecoder(enc).decode(buf); }catch{ try{ return new TextDecoder('utf-8').decode(buf);}catch{return''} } }
  function detectEncoding(buf){
    const u8=new Uint8Array(buf);
    if(u8.length>=3 && u8[0]===0xEF && u8[1]===0xBB && u8[2]===0xBF) return {encoding:'utf-8', text:new TextDecoder('utf-8').decode(u8.subarray(3))};
    if(u8.length>=2 && u8[0]===0xFF && u8[1]===0xFE) return {encoding:'utf-16le', text:new TextDecoder('utf-16le').decode(u8.subarray(2))};
    const cands=[]; ['utf-8','shift_jis','windows-1252'].forEach(enc=>{ try{ const dec=new TextDecoder(enc,{fatal:true}); const txt=dec.decode(u8); cands.push({enc,text:txt,jp:countJapaneseChars(txt)});}catch{} });
    if(!cands.length) return {encoding:'utf-8', text:new TextDecoder('utf-8').decode(u8)};
    cands.sort((a,b)=> (b.jp-a.jp) || (a.enc==='utf-8'?-1:1));
    return {encoding:cands[0].enc, text:cands[0].text};
  }
  function updateEncodingBadge(encoding,isAuto){
    const map={'utf-8':'UTF-8','shift_jis':'ANSI JP (Shift_JIS)','windows-1252':'ANSI Latin-1','utf-16le':'UTF-16 LE'};
    const label=map[encoding]||encoding; encodingBadge.textContent=label+(isAuto?' (auto)':''); encodingBadge.title=`Codifica√ß√£o usada: ${label}${isAuto?' (detectada automaticamente)':''}`;
  }

  let lastOtoBuffer=null,lastOtoFileName=''; let lastOtoEncoding='utf-8';

  async function loadOtoFromBuffer(buf,filename){
    const sel=encodingSelect?.value||'auto'; let res;
    if(sel==='auto'){ res=detectEncoding(buf); logMsg(`oto.ini carregado (${filename||'buffer'}) em ${res.encoding} (auto)`); updateEncodingBadge(res.encoding,true); }
    else { res={encoding:sel, text:decodeBuffer(buf,sel)}; logMsg(`oto.ini carregado (${filename||'buffer'}) em ${sel}`); updateEncodingBadge(sel,false); }
    lastOtoEncoding=res.encoding;
    rows=parseOto(res.text);
    if(files.length){
      for(const f of files){ if(!rows.find(r=> sameFile(r.filename,f.name))){
        rows.push({filename:f.name,alias:inferAlias(f.name),offset:0,consonant:0,cutoff:0,preutter:0,overlap:0});
      }}
    }
    if(rows.length){ if(selectedRowIndex<0) selectedRowIndex=0; selectRow(selectedRowIndex); }
    refreshOtoView(); renderAliasList();
  }

  /* ===== Arquivos ===== */
  const supportsDir = 'webkitdirectory' in pickFolder;
  let pickFiles=document.createElement('input'); pickFiles.type='file'; pickFiles.multiple=true; pickFiles.accept='audio/wav'; pickFiles.style.display='none'; document.body.appendChild(pickFiles);
  if(!supportsDir) btnFolder.textContent='Abrir arquivos .wav';
  btnFolder.addEventListener('click',()=>{ if(supportsDir) pickFolder.click(); else pickFiles.click(); });

  async function ingestFileList(list){
    const arr=[...list]; const wavs=arr.filter(f=>/\.wav$/i.test(f.name));
    if(!wavs.length){ alert('Nenhum .wav encontrado.'); return; }
    files=wavs.map(f=>({name:f.webkitRelativePath||f.name,file:f,url:URL.createObjectURL(f)}));
    for(const f of files){ if(!rows.find(r=> sameFile(r.filename,f.name))){
      rows.push({filename:f.name,alias:inferAlias(f.name),offset:0,consonant:0,cutoff:0,preutter:0,overlap:0});
    } }
    renderAliasList(); if(rows.length && selectedRowIndex<0) selectRow(0);
    $('btnSave').disabled = rows.length===0;
    logMsg(`Detectados ${files.length} arquivos .wav`);
  }
  pickFolder.addEventListener('change',e=> ingestFileList(e.target.files));
  pickFiles.addEventListener('change',e=> ingestFileList(e.target.files));

  function sameFile(a,b){ if(!a||!b) return false; if(a===b) return true; const ba=lower(basename(a)), bb=lower(basename(b)); return ba===bb || lower(a).endsWith('/'+bb) || lower(a).endsWith('\\'+bb); }
  function getFileIndexForFilename(fn){ let idx=files.findIndex(f=> f.name===fn); if(idx>=0) return idx; const b=lower(basename(fn)); idx=files.findIndex(f=> lower(basename(f.name))===b); return idx; }

  // DnD
  const leftPane=$('pane-files');
  ;['dragenter','dragover'].forEach(evt=> leftPane.addEventListener(evt,ev=>{ev.preventDefault();ev.stopPropagation();leftPane.classList.add('drop-active');}));
  ;['dragleave','drop'].forEach(evt=> leftPane.addEventListener(evt,ev=>{ev.preventDefault();ev.stopPropagation();leftPane.classList.remove('drop-active');}));
  leftPane.addEventListener('drop', async ev=>{
    const items=ev.dataTransfer?.items; const filesList=ev.dataTransfer?.files;
    if(items && items[0] && 'webkitGetAsEntry' in items[0]){
      const all = await getAllFilesFromDataTransferItems(items); await ingestFileList(all);
    } else if(filesList){ await ingestFileList(filesList); }
  });
  async function getAllFilesFromDataTransferItems(list){ const promises=[]; for(const item of list){
    const entry=item.webkitGetAsEntry?item.webkitGetAsEntry():null;
    if(entry){ promises.push(...await traverseFileTree(entry)); } else if(item.getAsFile){ const f=item.getAsFile(); if(f) promises.push(Promise.resolve(f)); } }
    return Promise.all(promises); }
  async function traverseFileTree(entry,path=''){
    if(entry.isFile){ return [new Promise(resolve=> entry.file(f=>{ f.webkitRelativePath=(path?path+'/':'')+f.name; resolve(f); }))]; }
    if(entry.isDirectory){ const reader=entry.createReader(); return [new Promise(resolve=>{
      reader.readEntries(async entries=>{ const ps=[]; for(const ent of entries){ ps.push(...await traverseFileTree(ent,(path?path+'/':'')+entry.name)); } resolve(Promise.all(ps)); });
    })].flat(); }
    return [];
  }

  /* ===== Carregar/Salvar oto.ini ===== */
  $('btnOto').addEventListener('click', ()=> pickOto.click());
  pickOto.addEventListener('change', async e=>{ const f=e.target.files[0]; if(!f) return; lastOtoFileName=f.name||''; lastOtoBuffer=await f.arrayBuffer(); await loadOtoFromBuffer(lastOtoBuffer,lastOtoFileName); });
  encodingSelect.addEventListener('change', ()=>{ if(lastOtoBuffer) loadOtoFromBuffer(lastOtoBuffer,lastOtoFileName); });

  function saveOtoWithEncoding(enc){
    const content=serializeOto(rows); let blob;
    if(enc==='shift_jis'){
      if(window.Encoding){ try{ const sj=window.Encoding.convert(content,'SJIS','UNICODE'); blob=new Blob([new Uint8Array(sj)],{type:'text/plain;charset=shift_jis'}); logMsg('oto.ini exportado em Shift_JIS (ANSI JP)'); }
        catch(e){ alert('Falha ao converter para Shift_JIS. Salvando em UTF-8.'); blob=new Blob([content],{type:'text/plain;charset=utf-8'}); } }
      else { alert('Sem Encoding.js: salvando em UTF-8.'); blob=new Blob([content],{type:'text/plain;charset=utf-8'}); }
    } else { blob=new Blob([content],{type:'text/plain;charset='+enc}); logMsg(`oto.ini exportado em ${enc}`); }
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='oto.ini'; a.click();
  }
  $('btnSave').addEventListener('click', ()=>{
    if(!rows.length) return;
    const preferred=lastOtoEncoding||'utf-8';
    const choice=prompt('Salvar como:\n1) UTF-8 (OpenUTAU)\n2) ANSI/Shift_JIS (UTAU legado JP)\n3) Mesma codifica√ß√£o lida ('+preferred+')\n\nDigite 1, 2 ou 3:','1');
    let enc='utf-8'; if(choice==='2') enc='shift_jis'; else if(choice==='3') enc=preferred; saveOtoWithEncoding(enc);
  });

  // Duplicar linha (atalho no topo antigo ficou ‚Äî mantemos via teclado)
  // Estrela via atalho
  addEventListener('keydown',e=>{
    if(selectedRowIndex<0) return;
    if(e.key==='S' || e.key==='s'){ toggleStarOnCurrent(); renderAliasList(); }
  });

  /* ===== Lista / Filtro ===== */
  function termsFromFilter(){
    const raw = filterInput.value.trim();
    if(!raw) return [];
    // divide por espa√ßos respeitando aspas
    const m = raw.match(/"([^"]+)"|(\S+)/g)||[];
    return m.map(t=> t.replace(/^"|"$/g,''));
  }
  function matchFilter(r){
    const terms=termsFromFilter(); const starredOnly=filterStarred.checked;
    if(starredOnly && !starSet.has(keyFor(r))) return false;
    if(!terms.length) return true;
    const hay = (r.alias||'')+' '+(r.filename||'');
    if(filterRegex.checked){
      try{
        // OR entre termos (cada termo vira um grupo)
        return terms.some(t=> new RegExp(t,'i').test(hay));
      }catch{ return true; }
    } else {
      const L=lower(hay);
      return terms.some(t=> L.includes(lower(t)));
    }
  }

  function ensurePrimarySelection(){
    if(selectedRowIndex>=0 && (!selectedRowIndices || !selectedRowIndices.length)){
      selectedRowIndices=[selectedRowIndex];
    }
  }

  function renderAliasList(){
    countAliases.textContent=String(rows.length);
    aliasList.innerHTML=''; ensurePrimarySelection();
    rows.forEach((r,idx)=>{
      if(!matchFilter(r)) return;
      const isSelected = selectedRowIndices?.includes(idx);
      const hasFile = getFileIndexForFilename(r.filename)>=0;
      const starred = starSet.has(keyFor(r));

      const div=document.createElement('div');
      div.className='flex items-center gap-2 px-2 py-2 text-sm rounded-md hover:bg-slate-500/10 cursor-pointer'+(isSelected?' bg-slate-500/10':'');
      const starBtn = `<button class="px-1 star" title="${starred?'Desmarcar ‚òÖ':'Marcar ‚òÖ'}">${starred?'‚òÖ':'‚òÜ'}</button>`;
      const aliasHtml = `<div class="font-mono text-xs truncate" title="${r.alias||'(sem alias)'}">${r.alias||'(sem alias)'}</div>`;
      const wavHtml = hasFile ? `<span class="tag" title="${basename(r.filename)}">${basename(r.filename)}</span>` : '<span class="tag" title=".wav ausente">! wav</span>';
      div.innerHTML = `${starBtn} ${aliasHtml} <div class="ml-auto flex items-center gap-2">${wavHtml}</div>`;

      // clique sele√ß√£o
      div.addEventListener('click',ev=>{
        if(ev.target && ev.target.classList.contains('star')){
          toggleStar(idx); ev.stopPropagation(); return;
        }
        if(ev.ctrlKey||ev.metaKey){
          if(!selectedRowIndices) selectedRowIndices=[];
          const p=selectedRowIndices.indexOf(idx);
          if(p>=0) selectedRowIndices.splice(p,1); else selectedRowIndices.push(idx);
          if(!selectedRowIndices.length){ selectedRowIndex=-1; currentName.textContent='(nenhum arquivo)'; currentBuffer=null; drawAll(); renderAliasList(); return; }
          selectedRowIndex=idx;
        } else if(ev.shiftKey && selectedRowIndices?.length){
          const last=selectedRowIndices[selectedRowIndices.length-1]; const a=Math.min(last,idx), b=Math.max(last,idx);
          selectedRowIndices=[]; for(let i=a;i<=b;i++) selectedRowIndices.push(i); selectedRowIndex=idx;
        } else { selectedRowIndices=[idx]; selectedRowIndex=idx; }
        selectRow(selectedRowIndex); ev.preventDefault();
      });

      aliasList.appendChild(div);
    });
    $('btnSave').disabled = rows.length===0;
    updateStarCounter();
  }

  filterInput.addEventListener('input',renderAliasList);
  filterRegex.addEventListener('change',renderAliasList);
  filterStarred.addEventListener('change',renderAliasList);

  btnSelectResults.addEventListener('click',()=>{
    selectedRowIndices=[]; rows.forEach((r,i)=>{ if(matchFilter(r)) selectedRowIndices.push(i); });
    if(selectedRowIndices.length){ selectedRowIndex=selectedRowIndices[0]; selectRow(selectedRowIndex); }
    renderAliasList();
  });
  btnClearSelection.addEventListener('click',()=>{ selectedRowIndices=[]; renderAliasList(); });
  btnStarResults.addEventListener('click',()=>{
    const targets=[]; rows.forEach((r,i)=>{ if(matchFilter(r)) targets.push(i); });
    const flipTo = targets.some(i=> !starSet.has(keyFor(rows[i]))); // se houver algum n√£o estrelado, marcamos todos
    for(const i of targets){ const k=keyFor(rows[i]); if(flipTo) starSet.add(k); else starSet.delete(k); }
    saveStars(); renderAliasList();
  });

  function toggleStar(idx){
    const k=keyFor(rows[idx]);
    if(starSet.has(k)) starSet.delete(k); else starSet.add(k);
    saveStars(); renderAliasList();
  }
  function toggleStarOnCurrent(){ if(selectedRowIndex<0) return; toggleStar(selectedRowIndex); }

  /* ===== Sele√ß√£o e WAV ===== */
  let audioDecodeAborter = {aborted:false};
  async function selectRow(rowIndex){
    selectedRowIndex = clamp(rowIndex, 0, rows.length-1);
    const r=rows[selectedRowIndex]; if(!r) return;
    loadParamsToUI();
    const fIdx=getFileIndexForFilename(r.filename);
    currentName.textContent=r.filename || '(sem arquivo)';

    if(fIdx>=0){
      audioDecodeAborter.aborted=true; audioDecodeAborter={aborted:false};
      await decodeAndDraw(files[fIdx], audioDecodeAborter);
      const dur=currentBuffer.duration*1000, vw=getViewWindowMs(dur);
      viewStartMs = clamp((r.offset||0) - vw/2, 0, Math.max(0, dur - vw));
      // espectrograma: calcula e desenha se habilitado
      if(toggleSpec.checked) await ensureSpectrogramFor(fIdx);
    } else { srInfo.textContent=''; currentBuffer=null; drawAll(); }
    renderAliasList();
  }

  async function decodeAndDraw(item, aborter){
    audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
    const arrbuf = await fetch(item.url).then(r=>r.arrayBuffer());
    if(aborter.aborted) return;
    currentBuffer = await audioCtx.decodeAudioData(arrbuf.slice(0));
    if(aborter.aborted) return;
    srInfo.textContent = `‚Ä¢ ${currentBuffer.sampleRate} Hz ‚Ä¢ ${currentBuffer.duration.toFixed(2)} s`;
    resizeCanvas(); drawAll();
  }

  /* ===== Tempo <-> X ===== */
  function getViewWindowMs(totalMs){ if(!totalMs) return 0; return Math.max(1, totalMs/Math.max(1, zoom)); }
  function msToX(ms){ if(!currentBuffer) return 0; const totalMs=currentBuffer.duration*1000; const vw=getViewWindowMs(totalMs); return ((ms - viewStartMs)/vw) * wave.width; }
  function xToMs(x){ if(!currentBuffer) return 0; const totalMs=currentBuffer.duration*1000; const vw=getViewWindowMs(totalMs); return viewStartMs + (x/wave.width)*vw; }

  /* ===== Waveform ===== */
  function drawWave(){
    const W=wave.width, H=wave.height, c=ctxWave; c.clearRect(0,0,W,H);
    c.fillStyle=getComputedStyle(document.body).getPropertyValue('--card')||'#fff'; c.fillRect(0,0,W,H);
    c.strokeStyle=getComputedStyle(document.body).getPropertyValue('--grid')||'#e5e7eb'; c.beginPath(); c.moveTo(0,H/2); c.lineTo(W,H/2); c.stroke();

    if(currentBuffer){
      const ch=currentBuffer.getChannelData(0);
      const totalMs=currentBuffer.duration*1000; const totalSamples=ch.length;
      const vw=getViewWindowMs(totalMs); const startMs=viewStartMs, endMs=startMs+vw;
      const startSamp=Math.floor((startMs/totalMs)*totalSamples); const endSamp=Math.min(totalSamples, Math.ceil((endMs/totalMs)*totalSamples));
      const samplesInView=Math.max(1, endSamp-startSamp); const step=Math.max(1, Math.floor(samplesInView/W));

      c.beginPath();
      let x=0;
      for(let i=startSamp;i<endSamp;i+=step){
        let min=1e9,max=-1e9; for(let j=0;j<step&&i+j<endSamp;j++){ const v=ch[i+j]; if(v<min)min=v; if(v>max)max=v; }
        const mid=H/2, scale=H*0.45*(vzoom||1);
        c.moveTo(x, mid + min*scale); c.lineTo(x, mid + max*scale);
        x+=1;
      }
      c.strokeStyle='#94a3b8'; c.stroke();
    }

    const cx=msToX(cursorMs); c.strokeStyle='#f97316'; c.beginPath(); c.moveTo(cx,0); c.lineTo(cx,H); c.stroke();
  }

  function drawParamFills(){
    if(!currentBuffer || selectedRowIndex<0) return;
    const p=rows[selectedRowIndex], totalMs=currentBuffer.duration*1000;
    const off=clamp(round0(p.offset||0),0,totalMs);
    const consDur=clamp(round0(p.consonant||0),0,Math.max(0,totalMs-off));
    const c=round0(p.cutoff||0);
    const consStart=off, consEnd=clamp(off+consDur,0,totalMs), cutAbs=clamp(off+Math.abs(c),0,totalMs);
    const f=(x1,x2,color,a)=>{ const ctx=ctxWave, W=ctx.canvas.width; const a1=Math.max(0,Math.min(W,Math.min(x1,x2))), b1=Math.max(0,Math.min(W,Math.max(x1,x2))); if(b1<=a1) return; ctx.save(); ctx.globalAlpha=a; ctx.fillStyle=color; ctx.fillRect(a1,0,b1-a1,ctx.canvas.height); ctx.restore(); };
    f(msToX(0),msToX(off),COLORS.offset,0.12);
    f(msToX(consStart),msToX(consEnd),COLORS.consonant,0.12);
    f(msToX(cutAbs),msToX(totalMs),COLORS.cutoff,0.12);
  }
  function markerAbs(p,id){ const totalMs=currentBuffer?Math.round(currentBuffer.duration*1000):0; if(id==='offset') return p.offset||0; if(id==='consonant') return (p.offset||0)+(p.consonant||0); if(id==='preutter') return (p.offset||0)+(p.preutter||0); if(id==='overlap') return (p.offset||0)+(p.overlap||0); if(id==='cutoff'){ const c=Math.round(p.cutoff||0); const abs=(p.offset||0)+Math.abs(c); return clamp(abs,0,totalMs);} return 0; }
  function drawMarkerLines(){
    if(selectedRowIndex<0) return; const p=rows[selectedRowIndex]; const W1=wave.width,H1=wave.height; ctxWave.save(); ctxWave.lineWidth=1;
    markers.forEach(m=>{ const x=msToX(markerAbs(p,m.id)); if(x<0||x>W1) return; ctxWave.strokeStyle=(m.id==='offset')?COLORS.offset:(m.id==='consonant')?COLORS.consonant:(m.id==='cutoff')?COLORS.cutoff:(m.id==='preutter')?COLORS.preutter:COLORS.overlap; ctxWave.beginPath(); ctxWave.moveTo(Math.round(x)+0.5,0); ctxWave.lineTo(Math.round(x)+0.5,H1); ctxWave.stroke(); });
    ctxWave.restore();
  }
  function drawMarkers(){
    labelsWrap.innerHTML=''; if(selectedRowIndex<0) return; const overlayH=wave.getBoundingClientRect().height; const p=rows[selectedRowIndex];
    markers.forEach(m=>{ const msAbs=markerAbs(p,m.id); const x=msToX(msAbs); if(x<0||x>wave.width) return;
      const h=document.createElement('div'); h.className='handle'; h.style.left=x+'px'; h.style.top='0px'; h.style.height=overlayH+'px'; h.dataset.mid=m.id; labelsWrap.appendChild(h);
      const lab=document.createElement('div'); lab.className='marker-label'+(selectedMarkerId===m.id?' marker-selected':''); lab.style.left=x+'px'; lab.style.top='14px'; lab.textContent=`${m.label} ${fmt(p[m.id]||0)}ms`; lab.dataset.mid=m.id; labelsWrap.appendChild(lab);
    });
  }

  /* ===== Spectrograma ===== */
  function hann(N){ const w=new Float32Array(N); for(let n=0;n<N;n++) w[n]=0.5*(1-Math.cos(2*Math.PI*n/(N-1))); return w; }
  const HANN_1024 = hann(1024);
  async function ensureSpectrogramFor(fileIndex){
    if(specCache.has(fileIndex)) { drawSpectrogram(fileIndex); return; }
    if(!currentBuffer) return;
    const ch=currentBuffer.getChannelData(0); const N=1024, hop=256;
    const cols = Math.max(1, Math.floor((ch.length - N)/hop)+1); const rows = N/2; // bins
    const FFT = window.FFT; const fft = new FFT(N);
    const w = HANN_1024;
    const data = new Float32Array(cols*rows);
    let minDB=+Infinity, maxDB=-Infinity;
    const re=new Float32Array(N), im=new Float32Array(N);

    for(let col=0, pos=0; col<cols; col++, pos+=hop){
      // janela
      for(let n=0;n<N;n++){ re[n]=(ch[pos+n]||0)*w[n]; im[n]=0; }
      fft.transform(re, im);
      // magnitude (0..N/2-1)
      for(let k=0;k<rows;k++){
        const rr=re[k], ii=im[k]; const mag = Math.sqrt(rr*rr+ii*ii);
        const db = 20*Math.log10(mag+1e-8); // dB relativo
        data[col*rows + k] = db;
        if(db<minDB) minDB=db; if(db>maxDB) maxDB=db;
      }
    }
    specCache.set(fileIndex, {cols,rows,data,minDB,maxDB, hop, N});
    drawSpectrogram(fileIndex);
  }

  function colorMap(t){ // 0..1 -> inferno simplificado
    t = clamp(t,0,1);
    const r = Math.min(255, Math.max(0, Math.floor(255 * (1.5*t))));
    const g = Math.min(255, Math.max(0, Math.floor(255 * Math.pow(t,1.5))));
    const b = Math.min(255, Math.max(0, Math.floor(255 * (t<0.5?(0.5- t): (1.0 - t))*1.6 )));
    return [r,g,b,255];
  }

  function drawSpectrogram(fileIndex){
    const cache=specCache.get(fileIndex); if(!cache || !currentBuffer) return;
    SPEC_WRAP.classList.toggle('hidden', !toggleSpec.checked);
    if(!toggleSpec.checked) return;

    // mapeia janela de visualiza√ß√£o em colunas do espectro
    const totalMs=currentBuffer.duration*1000; const vw=getViewWindowMs(totalMs);
    const totalCols=cache.cols;
    const msPerHop = (hopMs = 1000 * cache.hop / currentBuffer.sampleRate);
    const colStart = Math.max(0, Math.floor(viewStartMs / hopMs));
    const colEnd   = Math.min(totalCols-1, Math.ceil((viewStartMs+vw) / hopMs));
    const viewCols = Math.max(1, colEnd - colStart + 1);

    // dimensiona canvas em devicePixelRatio
    const ratio=Math.max(1,Math.floor(devicePixelRatio||1));
    const wrapW=spec.parentElement.getBoundingClientRect().width;
    spec.width=Math.max(300,Math.floor(wrapW*ratio));
    spec.height=Math.floor(180*ratio);
    sctx.setTransform(ratio,0,0,ratio,0,0);
    sctx.clearRect(0,0,spec.width,spec.height);

    const W=spec.width, H=spec.height, rows=cache.rows;
    const img=sctx.createImageData(W,H);
    const min=cache.minDB, max=cache.maxDB;
    for(let x=0;x<W;x++){
      const col = colStart + Math.floor((x/W)*viewCols);
      const base = col*rows;
      for(let y=0;y<H;y++){
        const bin = Math.floor((1 - y/H) * (rows-1)); // topo = agudos
        const v = cache.data[base + bin];
        const t = (v - min) / Math.max(1e-6, (max - min));
        const [r,g,b,a]=colorMap(t);
        const idx = (y*W + x)*4;
        img.data[idx]=r; img.data[idx+1]=g; img.data[idx+2]=b; img.data[idx+3]=a;
      }
    }
    sctx.putImageData(img,0,0);
  }

  /* ===== Mini, composi√ß√£o e intera√ß√£o ===== */
  function drawMini(){
    const W=mini.width, H=mini.height, c=mctx; c.clearRect(0,0,W,H);
    c.fillStyle=getComputedStyle(document.body).getPropertyValue('--card')||'#fff'; c.fillRect(0,0,W,H);
    c.strokeStyle=getComputedStyle(document.body).getPropertyValue('--grid')||'#e5e7eb'; c.beginPath(); c.moveTo(0,H/2); c.lineTo(W,H/2); c.stroke();
    if(!currentBuffer) return;
    const ch=currentBuffer.getChannelData(0); const step=Math.max(1, Math.floor(ch.length/W));
    c.beginPath(); let x=0; for(let i=0;i<ch.length;i+=step){ let min=1e9,max=-1e9; for(let j=0;j<step&&i+j<ch.length;j++){ const v=ch[i+j]; if(v<min)min=v; if(v>max)max=v; } const mid=H/2, scale=H*0.4; c.moveTo(x,mid+min*scale); c.lineTo(x,mid+max*scale); x+=1; }
    c.strokeStyle='#64748b'; c.stroke();
    const totalMs=currentBuffer.duration*1000; const vw=getViewWindowMs(totalMs); const x1=(viewStartMs/totalMs)*W; const x2=((viewStartMs+vw)/totalMs)*W;
    c.fillStyle='rgba(59,130,246,0.15)'; c.fillRect(x1,0,Math.max(2,x2-x1),H); c.strokeStyle='#3b82f6'; c.strokeRect(x1+0.5,0.5,Math.max(2,x2-x1)-1,H-1);
  }

  function drawAll(){ drawWave(); drawParamFills(); drawMarkerLines(); drawMarkers(); drawMini(); if(toggleSpec.checked){ const idx=getFileIndexForFilename(rows[selectedRowIndex]?.filename||''); if(idx>=0) drawSpectrogram(idx); } }

  labelsWrap.addEventListener('click', e=>{ const m=e.target?.dataset?.mid; if(!m) return; selectedMarkerId=m; drawAll(); });
  labelsWrap.addEventListener('mousedown', e=>{
    const t=e.target; if(!t.classList.contains('handle')) return; e.preventDefault(); const id=t.dataset.mid;
    const onMove=ev=> setParamSmart(id, xToMs(clamp(ev.clientX - wave.getBoundingClientRect().left,0,wave.getBoundingClientRect().width)));
    const onUp = ()=>{ removeEventListener('mousemove',onMove); removeEventListener('mouseup',onUp); };
    addEventListener('mousemove',onMove); addEventListener('mouseup',onUp);
  });

  function updateMouse(e){ const r=wave.getBoundingClientRect(); lastMouseX=clamp(e.clientX - r.left, 0, r.width); }
  wave.addEventListener('mousemove', e=>{ updateMouse(e); const rect=wave.getBoundingClientRect(); const x=clamp(e.clientX - rect.left,0,rect.width); cursorMs=xToMs(x); drawAll(); });
  wave.addEventListener('wheel', e=>{
    if(!currentBuffer) return;
    const rect=wave.getBoundingClientRect(); const x=clamp(e.clientX - rect.left,0,rect.width);
    if(e.shiftKey){ e.preventDefault(); const totalMs=currentBuffer.duration*1000; const vw=getViewWindowMs(totalMs); const dir=e.deltaY>0?1:-1; const delta=vw*0.1*dir; viewStartMs=clamp(viewStartMs+delta, 0, Math.max(0,totalMs-vw)); drawAll(); return; }
    if(e.altKey){ e.preventDefault(); vzoom=clamp((vzoom||1) * (e.deltaY>0?1/1.1:1.1), 0.25, 4); vzoomSlider.value=String(vzoom); vzoomLabel.textContent=vzoom.toFixed(2)+'√ó'; prefs.vzoom=vzoom; savePrefs(); drawAll(); return; }
    e.preventDefault(); // zoom horizontal anchor
    const anchorMs=xToMs(x); const factor=e.deltaY>0?1/1.1:1.1; const oldZoom=zoom; zoom=clamp(oldZoom*factor,1,128); zoomSlider.value=String(zoom); zoomLabel.textContent=`${zoom.toFixed(1)}√ó`;
    const totalMs=currentBuffer.duration*1000; const vw=getViewWindowMs(totalMs); viewStartMs = clamp(anchorMs - (x/wave.width)*vw, 0, Math.max(0,totalMs-vw)); drawAll();
  }, {passive:false});

  wave.addEventListener('click', ()=>{
    if(!currentBuffer || selectedRowIndex<0) return;
    const p=rows[selectedRowIndex], totalMs=currentBuffer.duration*1000;
    const offsetMs=clamp(Math.round(p.offset||0),0,totalMs); const c=Math.round(p.cutoff||0);
    let cutoffMs=clamp(offsetMs+Math.abs(c),0,totalMs); if(cutoffMs<=offsetMs) cutoffMs=totalMs;
    playRegion(offsetMs/1000, cutoffMs/1000);
  });

  function playRegion(startSec,endSec){
    if(!currentBuffer) return;
    if(source){ try{source.stop();}catch{} try{source.disconnect();}catch{} source=null; }
    audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)(); audioCtx.resume();
    source=audioCtx.createBufferSource(); source.buffer=currentBuffer; source.connect(audioCtx.destination);
    const dur=Math.max(0,endSec-startSec); const when=(audioCtx.currentTime||0)+0.01; source.start(when,startSec,dur); source.onended=()=>{source=null;};
  }
  $('btnPlay').addEventListener('click', ()=>{ if(!currentBuffer) return; if(source){ try{source.stop();}catch{} try{source.disconnect();}catch{} source=null; } else { audioCtx=audioCtx||new (window.AudioContext||window.webkitAudioContext)(); audioCtx.resume(); source=audioCtx.createBufferSource(); source.buffer=currentBuffer; source.connect(audioCtx.destination); source.start(audioCtx.currentTime+0.01, Math.max(0,cursorMs/1000)); source.onended=()=>{source=null;}; }});
  $('btnStop').addEventListener('click', ()=>{ if(source){ try{source.stop();}catch{} try{source.disconnect();}catch{} source=null; }});

  /* ===== Par√¢metros <-> UI ===== */
  function getCurrentRow(){ return selectedRowIndex>=0 ? rows[selectedRowIndex] : null; }
  function loadParamsToUI(){ const p=getCurrentRow(); if(!p) return; aliasIn.value=p.alias||''; offsetIn.value=fmt(p.offset||0); consonantIn.value=fmt(p.consonant||0); cutoffIn.value=fmt(p.cutoff||0); preutterIn.value=fmt(p.preutter||0); overlapIn.value=fmt(p.overlap||0); cursorMs=p.offset||0; drawAll(); }
  function syncInputsFromRow(p){ aliasIn.value=p.alias||''; offsetIn.value=fmt(p.offset||0); consonantIn.value=fmt(p.consonant||0); cutoffIn.value=fmt(p.cutoff||0); preutterIn.value=fmt(p.preutter||0); overlapIn.value=fmt(p.overlap||0); }

  function setParamSmart(id, msAbs){
    if(selectedRowIndex<0) return; const p=rows[selectedRowIndex]; const before={...p};
    const totalMs=currentBuffer?Math.round(currentBuffer.duration*1000):Number.POSITIVE_INFINITY;
    if(id==='offset'){ p.offset=Math.round(clamp(msAbs,0,totalMs)); p.consonant=Math.round(clamp(p.consonant||0,0,Math.max(0,totalMs-p.offset))); p.preutter=Math.round(clamp(p.preutter||0,0,Math.max(0,totalMs-p.offset))); p.overlap=Math.round(clamp(p.overlap||0,0,Math.max(0,totalMs-p.offset))); }
    else if(id==='consonant'){ p.consonant=Math.round(clamp(msAbs-(p.offset||0),0,Math.max(0,totalMs-(p.offset||0)))); }
    else if(id==='cutoff'){ const rel=msAbs-(p.offset||0); const relClamped=clamp(rel,0,Math.max(0,totalMs-(p.offset||0))); p.cutoff=-Math.round(relClamped); }
    else if(id==='preutter'||id==='overlap'){ const rel=msAbs-(p.offset||0); p[id]=Math.round(clamp(rel,0,Math.max(0,totalMs-(p.offset||0)))); }
    syncInputsFromRow(p); pushPatch(selectedRowIndex,before,{...p},'Ajuste '+id+' -> '+String(p[id]||0)+'ms'); refreshOtoView(); drawAll();
    // marcou progresso
    starSet.add(keyFor(p)); saveStars(); updateStarCounter(); renderAliasList();
  }

  // inputs (com edi√ß√£o em lote)
  ;[aliasIn,offsetIn,consonantIn,cutoffIn,preutterIn,overlapIn].forEach(inp=>{
    const fieldId=inp.id;
    inp.addEventListener('input',()=>{
      const p=getCurrentRow(); if(!p) return; const mainIndex=selectedRowIndex; const before={...p};
      const totalMs=currentBuffer?Math.round(currentBuffer.duration*1000):Number.POSITIVE_INFINITY;
      p.alias=aliasIn.value;
      p.offset=Math.round(clamp(Number(offsetIn.value)||0,0,totalMs));
      p.consonant=Math.round(clamp(Number(consonantIn.value)||0,0,Math.max(0,totalMs-p.offset)));
      { const raw=Math.abs(Number(cutoffIn.value)||0); const maxRel=Math.max(0,totalMs-p.offset); const rel=clamp(raw,0,maxRel); p.cutoff=-Math.round(rel); }
      p.preutter=Math.round(clamp(Number(preutterIn.value)||0,0,Math.max(0,totalMs-p.offset)));
      p.overlap=Math.round(clamp(Number(overlapIn.value)||0,0,Math.max(0,totalMs-p.offset)));
      syncInputsFromRow(p); pushPatch(mainIndex,before,{...p},'Editar campos do alias'); // patch principal

      if(selectedRowIndices && selectedRowIndices.length>1){
        selectedRowIndices.forEach(idx=>{ if(idx===mainIndex) return; const t=rows[idx]; if(!t) return; const b={...t};
          if(fieldId==='alias') t.alias=p.alias; else if(fieldId==='offset') t.offset=p.offset; else if(fieldId==='consonant') t.consonant=p.consonant; else if(fieldId==='cutoff') t.cutoff=p.cutoff; else if(fieldId==='preutter') t.preutter=p.preutter; else if(fieldId==='overlap') t.overlap=p.overlap;
          pushPatch(idx,b,{...t},'Editar campos (lote)');
          starSet.add(keyFor(t));
        });
        saveStars();
      }
      refreshOtoView(); drawAll(); renderAliasList();
    });
  });

  function refreshOtoView(){ const text=serializeOto(rows); const lines=text.split('\n'); countLines.textContent=String(lines.length); otoView.value=text; }
  otoView.addEventListener('input',()=>{ const cur=getCurrentRow(); rows=parseOto(otoView.value);
    if(cur){ let keepIdx=rows.findIndex(r=> r.filename===cur.filename && r.alias===cur.alias);
      if(keepIdx<0){ keepIdx=rows.findIndex(r=> lower(basename(r.filename))===lower(basename(cur.filename)) && r.alias===cur.alias ); }
      selectedRowIndex=keepIdx>=0?keepIdx:Math.min(selectedRowIndex,rows.length-1); }
    drawAll(); renderAliasList(); });

  // mini intera√ß√µes
  let draggingMini=false; mini.addEventListener('mousedown',e=>{ if(!currentBuffer) return; draggingMini=true; centerViewAtMs(miniXToMs(e)); });
  addEventListener('mouseup',()=> draggingMini=false);
  mini.addEventListener('mousemove',e=>{ if(!draggingMini || !currentBuffer) return; centerViewAtMs(miniXToMs(e)); });
  function miniXToMs(e){ const r=mini.getBoundingClientRect(); const x=clamp(e.clientX-r.left,0,r.width); const totalMs=currentBuffer.duration*1000; return (x/r.width)*totalMs; }
  function centerViewAtMs(ms){ const totalMs=currentBuffer.duration*1000; const vw=getViewWindowMs(totalMs); viewStartMs=clamp(ms - vw/2,0,Math.max(0,totalMs-vw)); drawAll(); }

  // sliders
  zoomSlider.addEventListener('input',e=>{ if(!currentBuffer) return; zoom=clamp(Number(e.target.value)||1,1,128); zoomLabel.textContent=`${Math.round(zoom)}√ó`; const totalMs=currentBuffer.duration*1000; const vw=getViewWindowMs(totalMs); viewStartMs=clamp(viewStartMs,0,Math.max(0,totalMs-vw)); drawAll(); });
  vzoomSlider.addEventListener('input',e=>{ vzoom=clamp(Number(e.target.value)||1,0.25,4); vzoomLabel.textContent=vzoom.toFixed(2)+'√ó'; prefs.vzoom=vzoom; savePrefs(); drawAll(); });

  // markers drag
  labelsWrap.addEventListener('mousedown',e=>{
    const t=e.target; if(!t.classList.contains('handle')) return;
    e.preventDefault(); const id=t.dataset.mid;
    const onMove=ev=> setParamSmart(id, xToMs(clamp(ev.clientX - wave.getBoundingClientRect().left,0,wave.getBoundingClientRect().width)));
    const onUp=()=>{ removeEventListener('mousemove',onMove); removeEventListener('mouseup',onUp); };
    addEventListener('mousemove',onMove); addEventListener('mouseup',onUp);
  });

  // espectrograma toggle
  toggleSpec.addEventListener('change', async ()=>{
    prefs.showSpec = toggleSpec.checked; savePrefs();
    if(toggleSpec.checked){ const fIdx=getFileIndexForFilename(rows[selectedRowIndex]?.filename||''); if(fIdx>=0) await ensureSpectrogramFor(fIdx); }
    drawAll();
  });

  function resizeCanvas(){
    const ratio=Math.max(1,Math.floor(devicePixelRatio||1));
    const wrap=wave.parentElement.getBoundingClientRect();
    wave.width=Math.max(600,Math.floor(wrap.width*ratio)); wave.height=Math.floor(260*ratio); ctxWave.setTransform(ratio,0,0,ratio,0,0);
    mini.width=Math.max(300,Math.floor(wrap.width*ratio)); mini.height=Math.floor(60*ratio); mctx.setTransform(ratio,0,0,ratio,0,0);
    // spec √© redimensionado em drawSpectrogram
  }
  const ro=new ResizeObserver(()=>{ resizeCanvas(); drawAll(); }); ro.observe(qs('#pane-wave .card-body'));
  addEventListener('resize',()=>{ resizeCanvas(); drawAll(); });

  // atalhos de navega√ß√£o/edi√ß√£o
  addEventListener('keydown',e=>{
    if(selectedRowIndex<0) return;
    const k=e.key, ku=k.toUpperCase();
    if(ku==='Y'){ // play/pause
      $('btnPlay').click(); return;
    }
    if(k==='0'){ const p=getCurrentRow(); if(!p) return; const copy={...p}; rows.splice(selectedRowIndex+1,0,copy); pushAction({type:'insert',index:selectedRowIndex+1,row:{...copy}},'Duplicar linha (tecla 0)'); selectedRowIndex++; renderAliasList(); refreshOtoView(); selectRow(selectedRowIndex); return; }
    if(k==='9'){ const p=getCurrentRow(); if(!p) return; const novo=prompt('Novo alias:', p.alias||''); if(novo!==null){ const before={...p}; p.alias=novo; pushPatch(selectedRowIndex,before,{...p},'Renomear alias'); syncInputsFromRow(p); refreshOtoView(); renderAliasList(); } return; }
    if(e.shiftKey && ku==='D'){ if(selectedRowIndex<0||!rows.length) return; const idx=selectedRowIndex; const removed=rows.splice(idx,1)[0]; pushAction({type:'remove',index:idx,row:{...removed}},'Deletar alias'); selectedRowIndex=Math.min(idx,rows.length-1); renderAliasList(); refreshOtoView(); if(rows.length) selectRow(selectedRowIndex); else { currentName.textContent='(nenhum arquivo)'; drawAll(); } return; }
    if(k==='ArrowDown'){ e.preventDefault(); if(selectedRowIndex<rows.length-1){ selectRow(selectedRowIndex+1); } return; }
    if(k==='ArrowUp'){ e.preventDefault(); if(selectedRowIndex>0){ selectRow(selectedRowIndex-1); } return; }
    const m=markers.find(mm=> mm.key===ku); if(!m) return; const msAbs=(lastMouseX!=null)?xToMs(lastMouseX):cursorMs; setParamSmart(m.id, msAbs);
  });

  // Tema + boot
  document.addEventListener('DOMContentLoaded', ()=>{
    loadPrefs(); loadStars(); applyTheme();
    $('btnTheme').addEventListener('click',()=>{ prefs.theme=(prefs.theme==='dark'?'light':'dark'); savePrefs(); applyTheme(); drawAll(); });
    $('toggleSpec').checked = !!prefs.showSpec;
    $('vzoom').value = prefs.vzoom||1; $('vzoomLabel').textContent=(prefs.vzoom||1).toFixed(2)+'√ó';
    initFloatables();
    renderAliasList();
    updateEncodingBadge('utf-8', true);
  });

  </script>
</body>

</html>

